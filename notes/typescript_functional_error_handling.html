<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-01-05 Tue 23:25 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Typescript Functional Error Handling</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="John Doe" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel='stylesheet' href='../style.css' />
<link rel='stylesheet' href='/../res/main.css' />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.cacheClassElem = elem.className;
         elem.cacheClassTarget = target.className;
         target.className = "code-highlighted";
         elem.className   = "code-highlighted";
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(elem.cacheClassElem)
         elem.className = elem.cacheClassElem;
       if(elem.cacheClassTarget)
         target.className = elem.cacheClassTarget;
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="/"> HOME </a>
</div><div id="content">
<h1 class="title">Typescript Functional Error Handling</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgf0ec0f9">1. typescript typed error handling, using Monads</a>
<ul>
<li><a href="#org1617502">1.1. TL;DR</a></li>
<li><a href="#orgabdba05">1.2. Background, introduction</a>
<ul>
<li><a href="#org475ce37">1.2.1. Fake Database</a></li>
</ul>
</li>
<li><a href="#org7fa72a7">1.3. Api function, first draft</a></li>
</ul>
</li>
<li><a href="#org371e613">2. Handling Known Errors</a>
<ul>
<li><a href="#orgdf9e3da">2.1. Error Types</a></li>
<li><a href="#org58777ce">2.2. Rewrite the API function with error types</a></li>
<li><a href="#org136ae80">2.3. <i>monads</i> to the rescue!</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgf0ec0f9" class="outline-2">
<h2 id="orgf0ec0f9"><span class="section-number-2">1</span> typescript typed error handling, using Monads</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org1617502" class="outline-3">
<h3 id="org1617502"><span class="section-number-3">1.1</span> TL;DR</h3>
<div class="outline-text-3" id="text-1-1">
<p>
get a typescript function, as part of it&rsquo;s type definition, to define the <i>types</i> of errors it might return.  Note, you cannot, in ts, <i>throw</i> these errors from the function, as they will lose their types.
</p>

<p>
We will implement a <i>monad</i> similar to <code>Promise.then/catch</code> that includes a typed success case and a typed failure pattern.
</p>
</div>
</div>

<div id="outline-container-orgabdba05" class="outline-3">
<h3 id="orgabdba05"><span class="section-number-3">1.2</span> Background, introduction</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Why do applications fail?  Recently I spent a long time working on a very large multi-user application.  It was my first time using typescript, after a long time of using python (django) and javascript for application design.
</p>

<p>
Well known to functional programmers, especially those who work in languages with static typing, is that side effects can introduce bugs in a system that is otherwise not expecting any.  For the purpose of this piece, we will look at a simple function: <code>getUser: (id: string) =&gt; User</code>, and use this function to come up with a sane way to handle errors.
</p>

<p>
First, we should be able to split the type of error into two camps: <i>expected</i> errors and <i>unexpected</i> errors.  Expected errors can be considered information, and are often thrown in cases where the <i>state</i> of the application has changed.  For our example <code>getUser</code>, the user may have been deleted, or left the application, and therefore no longer exists.  This is because the <code>getUser</code> function is the <code>api</code> function to the <code>mutable state</code> of the database.
</p>

<p>
Different clients of the function <code>getUser</code> might want to handle different failures differently.  In a case of <code>NotFound</code>, a frontend client displaying the user&rsquo;s profile might want to direct to a page saying the user was not found.  Getting a list of users, however, might simply want to not include the user&rsquo;s which were not found.  Furthermore, our function <code>getUser</code> might want to throw an error specifically stating that the input of the function was not valid.  In <i>theory</i>, the typescript compiler should catch this last sort of error for us, but in <i>practice</i>, in a world of side effects, a client might send complete bullshit data to the <code>getUser</code> function.
</p>
</div>

<div id="outline-container-org475ce37" class="outline-4">
<h4 id="org475ce37"><span class="section-number-4">1.2.1</span> Fake Database</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
Let&rsquo;s put together a barebones, fake database application to run the rest of our code:
(this isn&rsquo;t so important, we are just laying the groundwork)
</p>

<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #666;">type</span> <span style="color: #bbb8ab;">User</span> = <span style="color: #ccc8bc;">{</span> name: <span style="color: #666;">string</span> <span style="color: #ccc8bc;">}</span> <span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">a dirt simple user type</span>
<span style="color: #666;">type</span> <span style="color: #bbb8ab;">DB</span> = <span style="color: #ccc8bc;">{</span> <span style="color: #bbb8ab;">[</span>id: <span style="color: #666;">string</span><span style="color: #bbb8ab;">]</span>: <span style="color: #bbb8ab;">User</span> <span style="color: #ccc8bc;">}</span> <span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">a fake database as a data-object</span>

<span style="color: #666;">const</span> <span style="color: #333;">fakeDb</span>: <span style="color: #bbb8ab;">DB</span> = <span style="color: #ccc8bc;">{</span>
  <span style="color: teal;">"1"</span>: <span style="color: #bbb8ab;">{</span> name: <span style="color: teal;">"pablo"</span> <span style="color: #bbb8ab;">}</span>,
  <span style="color: teal;">"2"</span>: <span style="color: #bbb8ab;">{</span> name: <span style="color: teal;">"kristina"</span> <span style="color: #bbb8ab;">}</span>,
  <span style="color: teal;">"4"</span>: <span style="color: #bbb8ab;">{</span> name: <span style="color: teal;">"hildegard von bingen"</span> <span style="color: #bbb8ab;">}</span>,
<span style="color: #ccc8bc;">}</span>

<span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">fake a database getter function as a promise</span>
<span style="color: #666;">const</span> <span style="color: #333;">db</span> = <span style="color: #ccc8bc;">{</span>
  <span style="color: #666;">get</span>: <span style="color: #bbb8ab;">(</span>id: <span style="color: #666;">string</span><span style="color: #bbb8ab;">)</span>: <span style="color: #bbb8ab;">Promise</span>&lt;<span style="color: #bbb8ab;">User</span> | <span style="color: #bbb8ab;">undefined</span>&gt; <span style="color: #666;">=&gt;</span>
    Promise.<span style="color: #111; font-style: italic;">resolve</span><span style="color: #bbb8ab;">(</span>fakeDb<span style="color: #666;">[</span>id<span style="color: #666;">]</span><span style="color: #bbb8ab;">)</span>,
<span style="color: #ccc8bc;">}</span>

<span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">log a few examples:</span>

db.<span style="color: #111; font-style: italic;">get</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">"1"</span><span style="color: #ccc8bc;">)</span>.<span style="color: #111; font-style: italic;">then</span><span style="color: #ccc8bc;">(</span><span style="color: #bbb8ab;">console</span>.log<span style="color: #ccc8bc;">)</span>;
db.<span style="color: #111; font-style: italic;">get</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">"3"</span><span style="color: #ccc8bc;">)</span>.<span style="color: #111; font-style: italic;">then</span><span style="color: #ccc8bc;">(</span><span style="color: #bbb8ab;">console</span>.log<span style="color: #ccc8bc;">)</span>;
db.<span style="color: #111; font-style: italic;">get</span><span style="color: #ccc8bc;">(</span><span style="color: #666;">null</span><span style="color: #ccc8bc;">)</span>.<span style="color: #111; font-style: italic;">then</span><span style="color: #ccc8bc;">(</span><span style="color: #bbb8ab;">console</span>.log<span style="color: #ccc8bc;">)</span>;

</pre>
</div>

<pre class="example">
Promise { &lt;pending&gt; }
{ name: 'pablo' }
undefined
undefined
</pre>
</div>
</div>
</div>


<div id="outline-container-org7fa72a7" class="outline-3">
<h3 id="org7fa72a7"><span class="section-number-3">1.3</span> Api function, first draft</h3>
<div class="outline-text-3" id="text-1-3">
<p>
It&rsquo;s good application design to not allow client modules to touch the database directly, and instead a layer should be built that can do precisely things such as handle errors, deal with known cases, sanitize inputs, and in the future, map db types to application types.  But this is all something for later.  Today, we want to look at errors.  Specifically, errors in our <code>getUser</code> function.
</p>

<p>
Especially coming from a python world, <i>throwing</i> errors and catching them becomes the norm.  Let&rsquo;s take a look at that approach here (we will be rewriting this as the purpose of this article):
</p>

<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #666;">let</span> <span style="color: #333;">isLoggedIn</span> = <span style="color: #666;">true</span>; <span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">a fake little state variable</span>

<span style="color: #666;">const</span> <span style="color: #333;">getUser</span>
  : <span style="color: #ccc8bc;">(</span>id: <span style="color: #666;">string</span><span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> Promise&lt;<span style="color: #bbb8ab;">User</span>&gt; <span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">type definition</span>
  = <span style="color: #111; font-style: italic;">async</span> <span style="color: #ccc8bc;">(</span>id<span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> <span style="color: #ccc8bc;">{</span>
    <span style="color: #111; font-style: italic;">if</span> <span style="color: #bbb8ab;">(</span>!isLoggedIn<span style="color: #bbb8ab;">)</span> <span style="color: #bbb8ab;">{</span>
      <span style="color: #666;">throw</span> <span style="color: #666;">new</span> <span style="color: #111; font-style: italic;">Error</span><span style="color: #666;">(</span><span style="color: teal;">`bad user! that's illegal`</span><span style="color: #666;">)</span>;
    <span style="color: #bbb8ab;">}</span>
        <span style="color: #666;">const</span> <span style="color: #333;">user</span> = <span style="color: #666;">await</span> db.<span style="color: #111; font-style: italic;">get</span><span style="color: #bbb8ab;">(</span>id<span style="color: #bbb8ab;">)</span>;

    <span style="color: #111; font-style: italic;">if</span> <span style="color: #bbb8ab;">(</span>!user<span style="color: #bbb8ab;">)</span> <span style="color: #bbb8ab;">{</span>
      <span style="color: #666;">throw</span> <span style="color: #666;">new</span> <span style="color: #111; font-style: italic;">Error</span><span style="color: #666;">(</span><span style="color: teal;">`user ${id} not found`</span><span style="color: #666;">)</span>;
    <span style="color: #bbb8ab;">}</span>
    <span style="color: #666;">return</span> user
  <span style="color: #ccc8bc;">}</span>

<span style="color: #111; font-style: italic;">getUser</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">"1"</span><span style="color: #ccc8bc;">)</span>.<span style="color: #111; font-style: italic;">then</span><span style="color: #ccc8bc;">(</span><span style="color: #bbb8ab;">console</span>.log<span style="color: #ccc8bc;">)</span>;
<span style="color: #111; font-style: italic;">getUser</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">"77"</span><span style="color: #ccc8bc;">)</span>
  .<span style="color: #111; font-style: italic;">then</span><span style="color: #ccc8bc;">(</span><span style="color: #bbb8ab;">()</span> <span style="color: #666;">=&gt;</span> <span style="color: #bbb8ab;">console</span>.<span style="color: #111; font-style: italic;">log</span><span style="color: #bbb8ab;">(</span><span style="color: teal;">`this wont happen`</span><span style="color: #bbb8ab;">)</span><span style="color: #ccc8bc;">)</span> <span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">77 fails, so we catch it</span>
  .<span style="color: #111; font-style: italic;">catch</span><span style="color: #ccc8bc;">(</span><span style="color: #bbb8ab;">(</span>e<span style="color: #bbb8ab;">)</span> <span style="color: #666;">=&gt;</span> <span style="color: #bbb8ab;">console</span>.<span style="color: #111; font-style: italic;">log</span><span style="color: #bbb8ab;">(</span><span style="color: teal;">`caught: ${e}`</span><span style="color: #bbb8ab;">)</span><span style="color: #ccc8bc;">)</span>;
</pre>
</div>
<pre class="example">
Promise { &lt;pending&gt; }
{ name: 'pablo' }
caught: Error: user 77 not found
</pre>


<p>
From the above results, you can see that we have now handed <i>very</i> userful information back from <code>getUser</code> about <i>why</i> the error failed.
</p>

<p>
However, it is still difficult for the client application to <i>act</i> on the different types of errors.  What we would like to do, in pseudo-Code, is this:
</p>

<pre class="example">
// pseudo-code
getUser(id)
  .then(processResult)
  .catch((e) =&gt; {
    if (e === notFoundError) goToNotFound();
    if (e === notLoggedInError) goToLogin();
  });
</pre>

<p>
To do this, we deffinitely need better error types.
</p>
</div>
</div>
</div>

<div id="outline-container-org371e613" class="outline-2">
<h2 id="org371e613"><span class="section-number-2">2</span> Handling Known Errors</h2>
<div class="outline-text-2" id="text-2">
<p>
The advantage of typescript is in the name: typing.  We can easily make a few error types to test our results against.
</p>
</div>

<div id="outline-container-orgdf9e3da" class="outline-3">
<h3 id="orgdf9e3da"><span class="section-number-3">2.1</span> Error Types</h3>
<div class="outline-text-3" id="text-2-1">
<p>
The first thing we need to do is define a few error types.  In keeping with our very simple example, let&rsquo;s define two types, <code>NotFoundError</code> and <code>NoAuthError</code>.  What I am actually doing below is using the <code>ReturnType</code> of the <i>error creator</i> functions (as const) to create the types, but this doesn&rsquo;t need to be worried about now, it simply reduces boilerplate.  At the end of the day you have two types of errors, and these can be tested against
</p>

<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">create a very generic error type</span>
<span style="color: #666;">type</span> <span style="color: #bbb8ab;">Err</span> = <span style="color: #ccc8bc;">{</span>
  msg: <span style="color: #666;">string</span>;
  <span style="color: #666;">readonly</span> _type: <span style="color: #666;">string</span>;
<span style="color: #ccc8bc;">}</span>;

<span style="color: #666;">const</span> <span style="color: #333;">makeErr</span> =
  <span style="color: #ccc8bc;">(</span>_type: <span style="color: #666;">string</span><span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span>
    <span style="color: #ccc8bc;">(</span>msg: <span style="color: #666;">string</span><span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span>
      &lt;<span style="color: #666;">const</span>&gt;<span style="color: #ccc8bc;">{</span>
        _type,
        msg,
      <span style="color: #ccc8bc;">}</span>

<span style="color: #666;">const</span> <span style="color: #333;">notFoundError</span> = <span style="color: #111; font-style: italic;">makeErr</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">"NotFoundError"</span><span style="color: #ccc8bc;">)</span>

<span style="color: #666;">type</span> <span style="color: #bbb8ab;">NotFoundError</span> = ReturnType&lt;<span style="color: #bbb8ab;">typeof</span> <span style="color: #bbb8ab;">notFoundError</span>&gt;

<span style="color: #666;">const</span> <span style="color: #333;">isNotFoundError</span> =
  <span style="color: #ccc8bc;">(</span>e<span style="color: #ccc8bc;">)</span>: e is NotFoundError <span style="color: #666;">=&gt;</span>
    e._type === <span style="color: teal;">"NotFoundError"</span>;


<span style="color: #666;">const</span> <span style="color: #333;">noAuthError</span> = <span style="color: #111; font-style: italic;">makeErr</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">"NoAuthError"</span><span style="color: #ccc8bc;">)</span>

<span style="color: #666;">type</span> <span style="color: #bbb8ab;">NoAuthError</span> = ReturnType&lt;<span style="color: #bbb8ab;">typeof</span> <span style="color: #bbb8ab;">noAuthError</span>&gt;

<span style="color: #666;">const</span> <span style="color: #333;">isNoAuthError</span> =
  <span style="color: #ccc8bc;">(</span>e<span style="color: #ccc8bc;">)</span>: e is NoAuthError <span style="color: #666;">=&gt;</span>
    e._type === <span style="color: teal;">"NoAuthError"</span>;


<span style="color: #bbb8ab;">console</span>.<span style="color: #111; font-style: italic;">log</span><span style="color: #ccc8bc;">(</span><span style="color: #111; font-style: italic;">notFoundError</span><span style="color: #bbb8ab;">(</span><span style="color: teal;">`shake it off, shake it off oh oh oh`</span><span style="color: #bbb8ab;">)</span><span style="color: #ccc8bc;">)</span>; <span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">the type of notFoundError(x) is NotFoundError</span>
</pre>
</div>
<pre class="example">
{ _type: 'NotFoundError', msg: 'shake it off, shake it off oh oh oh' }
</pre>


<p>
Note: Notice that we will not include a stack any more in our errors.  With <i>expected</i> errors, the stack should no longer be important.
</p>
</div>
</div>

<div id="outline-container-org58777ce" class="outline-3">
<h3 id="org58777ce"><span class="section-number-3">2.2</span> Rewrite the API function with error types</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Now, let&rsquo;s rewrite our little api <code>getUser</code> function to actually throw these errors, and then re-implement the client pseudo-code as real code
</p>

<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">rewrite our function to use error types</span>
<span style="color: #666;">const</span> <span style="color: #333;">getUser</span>
  : <span style="color: #ccc8bc;">(</span>id: <span style="color: #666;">string</span><span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> Promise&lt;<span style="color: #bbb8ab;">User</span> | <span style="color: #666;">never</span>&gt; <span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">type definition</span>
  = <span style="color: #111; font-style: italic;">async</span> <span style="color: #ccc8bc;">(</span>id<span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> <span style="color: #ccc8bc;">{</span>
    <span style="color: #111; font-style: italic;">if</span> <span style="color: #bbb8ab;">(</span>!isLoggedIn<span style="color: #bbb8ab;">)</span> <span style="color: #bbb8ab;">{</span>
      <span style="color: #666;">throw</span> <span style="color: #111; font-style: italic;">noAuthError</span><span style="color: #666;">(</span><span style="color: teal;">`stop, citizen! you are doing something which is not allowed!`</span><span style="color: #666;">)</span>
    <span style="color: #bbb8ab;">}</span>
    <span style="color: #666;">const</span> <span style="color: #333;">user</span> = <span style="color: #666;">await</span> db.<span style="color: #111; font-style: italic;">get</span><span style="color: #bbb8ab;">(</span>id<span style="color: #bbb8ab;">)</span>;

    <span style="color: #111; font-style: italic;">if</span> <span style="color: #bbb8ab;">(</span>!user<span style="color: #bbb8ab;">)</span> <span style="color: #bbb8ab;">{</span>
      <span style="color: #666;">throw</span> <span style="color: #111; font-style: italic;">notFoundError</span><span style="color: #666;">(</span><span style="color: teal;">`this user id: ${id} not found. silly you!`</span><span style="color: #666;">)</span>
    <span style="color: #bbb8ab;">}</span>
    <span style="color: #666;">return</span> user
  <span style="color: #ccc8bc;">}</span>

<span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">use, and test against those error types</span>

<span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">first, against a user we know exists</span>
<span style="color: #111; font-style: italic;">getUser</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">"2"</span><span style="color: #ccc8bc;">)</span>
  .<span style="color: #111; font-style: italic;">then</span><span style="color: #ccc8bc;">(</span>
    <span style="color: #bbb8ab;">(</span>u<span style="color: #bbb8ab;">)</span> <span style="color: #666;">=&gt;</span> <span style="color: #bbb8ab;">console</span>.<span style="color: #111; font-style: italic;">log</span><span style="color: #bbb8ab;">(</span><span style="color: teal;">`got user ${u.name}`</span><span style="color: #bbb8ab;">)</span><span style="color: #ccc8bc;">)</span>

<span style="color: #111; font-style: italic;">getUser</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">"666"</span><span style="color: #ccc8bc;">)</span>
  .<span style="color: #111; font-style: italic;">then</span><span style="color: #ccc8bc;">(</span>
    <span style="color: #bbb8ab;">(</span>u<span style="color: #bbb8ab;">)</span> <span style="color: #666;">=&gt;</span> <span style="color: #bbb8ab;">console</span>.<span style="color: #111; font-style: italic;">log</span><span style="color: #bbb8ab;">(</span><span style="color: teal;">`got user ${u.name}`</span><span style="color: #bbb8ab;">)</span><span style="color: #ccc8bc;">)</span> <span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">this won't happen</span>
  .<span style="color: #111; font-style: italic;">catch</span><span style="color: #ccc8bc;">(</span>
    <span style="color: #bbb8ab;">(</span>e<span style="color: #bbb8ab;">)</span> <span style="color: #666;">=&gt;</span>
      <span style="color: #111; font-style: italic;">isNotFoundError</span><span style="color: #bbb8ab;">(</span>e<span style="color: #bbb8ab;">)</span>
        ? <span style="color: #bbb8ab;">console</span>.<span style="color: #111; font-style: italic;">log</span><span style="color: #bbb8ab;">(</span>
          <span style="color: teal;">`user 666 not found, but we know that from here now!`</span><span style="color: #bbb8ab;">)</span>
        : <span style="color: #111; font-style: italic;">isNoAuthError</span><span style="color: #bbb8ab;">(</span>e<span style="color: #bbb8ab;">)</span>
          ? <span style="color: #bbb8ab;">console</span>.<span style="color: #111; font-style: italic;">log</span><span style="color: #bbb8ab;">(</span><span style="color: teal;">`you are not logged in, caught it`</span><span style="color: #bbb8ab;">)</span>
          : <span style="color: #bbb8ab;">console</span>.<span style="color: #111; font-style: italic;">log</span><span style="color: #bbb8ab;">(</span><span style="color: teal;">`something truly unexpected happened`</span><span style="color: #bbb8ab;">)</span><span style="color: #ccc8bc;">)</span>

</pre>
</div>

<pre class="example">
Promise { &lt;pending&gt; }
got user kristina
user 666 not found, but we know that from here now!
</pre>


<p>
Success!  we are now able to distinguish between errors and act on them accordingly.
</p>

<p>
<i>Hooooowever</i>
</p>

<p>
the problem still is you <i>cannot distinguish the error types</i> in the function definition.  there is <i>no way</i> to type out what the function <i>throws</i>.
</p>

<p>
Put differently, <i>throwing</i> errors <i>always</i> results in the <i>never</i> type.  Typescript is supposed to allow for very specific type definitions of functions, but in this case you either get the defined type or&#x2026;. well, <i>never.</i>
</p>

<p>
Take another look at the function definition: <code>getUser: (id: string) =&gt; Promise&lt;User | never&gt;</code>
</p>

<p>
In our small, simple function, it is pretty easy to look through the function, and see which errors it could throw, and that clients of the function should possibly test against. In cases where a function calls nested or imported sub-routines that might throw their own errors, this becomes difficult to handle.
</p>

<p>
Additionally, the creator of the <code>getUser</code> function might want to <i>force</i> it&rsquo;s clients and consumers to deal with particular cases.  Bad input springs to mind.
</p>

<p>
Realistically, what we want is the error <i>types</i> in the function definition.
</p>
</div>
</div>

<div id="outline-container-org136ae80" class="outline-3">
<h3 id="org136ae80"><span class="section-number-3">2.3</span> <i>monads</i> to the rescue!</h3>
<div class="outline-text-3" id="text-2-3">
<p>
this is similar to re-implementing promises, actually
</p>

<p>
the change here is that <code>catch</code> is only used any more for <i>unexpected</i> results, everything else is handled as part of the new data-flow type.
</p>


<p>
this would require our new <code>doThing</code> function to look a lot closer to this:
</p>

<ul class="org-ul">
<li><i>codify</i> expected errors, and include them in the type definitions of functions</li>

<li><i>share</i> firebase function types : put one in <code>functions/src/index</code> and one in your <code>api</code> layer linking to the function by string.  this will keep both up to date</li>
</ul>

<div class="org-src-container">
<pre class="src src-jupyter-typescript">
<span style="color: #666;">type</span> <span style="color: #bbb8ab;">SuccessOrFailure</span> = <span style="color: #ccc8bc;">{</span>
<span style="color: #ccc8bc;">}</span>

</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: John Doe</p>
<p class="date">Created: 2021-01-05 Tue 23:25</p>
</div>
</body>
</html>
