<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-01-15 Fri 06:05 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Typescript typed error handling</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="John Doe" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel='stylesheet' href='../style.css' />
<link rel='stylesheet' href='/../res/main.css' />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.cacheClassElem = elem.className;
         elem.cacheClassTarget = target.className;
         target.className = "code-highlighted";
         elem.className   = "code-highlighted";
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(elem.cacheClassElem)
         elem.className = elem.cacheClassElem;
       if(elem.cacheClassTarget)
         target.className = elem.cacheClassTarget;
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="/"> HOME </a>
</div><div id="content">
<h1 class="title">Typescript typed error handling</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org6728124">1. Typescript typed error handling</a>
<ul>
<li>
<ul>
<li><a href="#orgb3f280b">1.0.1. TLDR</a></li>
<li><a href="#org1e3fc11">1.0.2. Introduction</a></li>
<li><a href="#orge3aa39a">1.0.3. Lay the groundwork</a></li>
<li><a href="#org7fa72a7">1.0.4. Api function, first draft</a></li>
</ul>
</li>
<li><a href="#org371e613">1.1. Handling Known Errors</a>
<ul>
<li><a href="#orgdf9e3da">1.1.1. Error Types</a></li>
<li><a href="#orgdc20385">1.1.2. Rewrite the API function</a></li>
<li><a href="#org136ae80">1.1.3. <i>monads</i> to the rescue!</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org6728124" class="outline-2">
<h2 id="org6728124"><span class="section-number-2">1</span> Typescript typed error handling</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgb3f280b" class="outline-4">
<h4 id="orgb3f280b"><span class="section-number-4">1.0.1</span> TLDR</h4>
<div class="outline-text-4" id="text-1-0-1">
<p>
Given a typescript function, we want to define the <i>types</i> of errors it might encounter as part of the function&rsquo;s <i>type definition</i>. This will help consumers of the function reason about it&rsquo;s result, and separate the idea of <i>expected</i> errors, which may arise out of changes outside of the application, from <i>unexpected</i> ones, which we do not have a case to handle.
</p>

<p>
We will implement a <i>monad</i> similar to <code>Promise.then/catch</code> that includes a typed success case and a typed failure pattern.
</p>
</div>
</div>

<div id="outline-container-org1e3fc11" class="outline-4">
<h4 id="org1e3fc11"><span class="section-number-4">1.0.2</span> Introduction</h4>
<div class="outline-text-4" id="text-1-0-2">
<p>
Why do applications fail?  Recently I spent a long time working on a very large multi-user application.  It was my first time using typescript, after a long time of using python (django) and javascript for application design.
</p>

<p>
Well known to functional programmers, especially those who work in languages with static typing, is that side effects can introduce bugs in a system that is otherwise not expecting any.  For the purpose of this piece, we will look at a simple function: <code>getUser: (id: string) =&gt; User</code>, and use this function to come up with a sane way to handle errors.
</p>

<p>
First, we should be able to split the type of error into two camps: <i>expected</i> errors and <i>unexpected</i> errors.  Expected errors can be considered information, and are often thrown in cases where the <i>state</i> of the application has changed.  For our example <code>getUser</code>, the user may have been deleted, or left the application, and therefore no longer exists.  This is because the <code>getUser</code> function is the <code>api</code> function to the <code>mutable state</code> of the database.
</p>

<p>
Different clients of the function <code>getUser</code> might want to handle different failures differently.  In a case of <code>NotFound</code>, a frontend client displaying the user&rsquo;s profile might want to direct to a page saying the user was not found.  Getting a list of users, however, might simply want to not include the user&rsquo;s which were not found.  Furthermore, our function <code>getUser</code> might want to throw an error specifically stating that the input of the function was not valid.  In <i>theory</i>, the typescript compiler should catch this last sort of error for us, but in <i>practice</i>, in a world of side effects, a client might send complete bullshit data to the <code>getUser</code> function.
</p>
</div>
</div>

<div id="outline-container-orge3aa39a" class="outline-4">
<h4 id="orge3aa39a"><span class="section-number-4">1.0.3</span> Lay the groundwork</h4>
<div class="outline-text-4" id="text-1-0-3">
<p>
Let&rsquo;s put together a barebones, fake database application to run the rest of our code:
(this isn&rsquo;t so important, we are just laying the groundwork)
</p>

<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #666;">type</span> <span style="color: #bbb8ab;">User</span> = <span style="color: #ccc8bc;">{</span> name<span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">string</span> <span style="color: #ccc8bc;">}</span> <span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">a dirt simple user type</span>
<span style="color: #666;">type</span> <span style="color: #bbb8ab;">DB</span> = <span style="color: #ccc8bc;">{</span> <span style="color: #ccc8bc;">[</span>id<span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">string</span><span style="color: #ccc8bc;">]</span><span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">User</span> <span style="color: #ccc8bc;">}</span> <span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">a fake database as a data-object</span>

<span style="color: #666;">const</span> <span style="color: #333;">fakeDb</span><span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">DB</span> = <span style="color: #ccc8bc;">{</span>
  <span style="color: teal;">"1"</span><span style="color: #bbb8ab;">:</span> <span style="color: #ccc8bc;">{</span> name<span style="color: #bbb8ab;">:</span> <span style="color: teal;">"pablo"</span> <span style="color: #ccc8bc;">}</span><span style="color: #bbb8ab;">,</span>
  <span style="color: teal;">"2"</span><span style="color: #bbb8ab;">:</span> <span style="color: #ccc8bc;">{</span> name<span style="color: #bbb8ab;">:</span> <span style="color: teal;">"kristina"</span> <span style="color: #ccc8bc;">}</span><span style="color: #bbb8ab;">,</span>
  <span style="color: teal;">"3"</span><span style="color: #bbb8ab;">:</span> <span style="color: #ccc8bc;">{</span> name<span style="color: #bbb8ab;">:</span> <span style="color: teal;">"hildegard von bingen"</span> <span style="color: #ccc8bc;">}</span><span style="color: #bbb8ab;">,</span>
<span style="color: #ccc8bc;">}</span>

<span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">fake a database getter function as a promise</span>
<span style="color: #666;">const</span> <span style="color: #333;">db</span> = <span style="color: #ccc8bc;">{</span>
  <span style="color: #666;">get</span><span style="color: #bbb8ab;">:</span> <span style="color: #ccc8bc;">(</span>id<span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">string</span><span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">Promise</span>&lt;<span style="color: #bbb8ab;">User</span> | <span style="color: #bbb8ab;">undefined</span>&gt; <span style="color: #666;">=&gt;</span>
    Promise<span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">resolve</span><span style="color: #ccc8bc;">(</span>fakeDb<span style="color: #ccc8bc;">[</span>id<span style="color: #ccc8bc;">]</span><span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">,</span>
<span style="color: #ccc8bc;">}</span>
</pre>
</div>
<p>
Now, we should be able to use our fake database like so:
</p>
<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #666;">await</span> db<span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">get</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">"1"</span><span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">then</span><span style="color: #ccc8bc;">(</span><span style="color: #bbb8ab;">console.</span>log<span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">;</span>
</pre>
</div>
<pre class="example">
{ name: 'pablo' }
</pre>


<p>
In a real world application, the <i>state</i> of the database would be constantly changing, so it could happen that you query a user who no longer exists.  In our case, we know that the users <code>1</code>, <code>2</code>, and <code>3</code> exist.
</p>

<p>
Our &rsquo;database&rsquo; will return <code>undefined</code> when queried for a user who does not exist:
</p>
<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #666;">await</span> db<span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">get</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">"4"</span><span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">then</span><span style="color: #ccc8bc;">(</span><span style="color: #bbb8ab;">console.</span>log<span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">;</span>
</pre>
</div>
<pre class="example">
undefined
</pre>


<p>
and will also return <code>undefined</code> when you query with &rsquo;bad&rsquo; data:
</p>
<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #666;">await</span> db<span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">get</span><span style="color: #ccc8bc;">(</span><span style="color: #666;">null</span><span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">then</span><span style="color: #ccc8bc;">(</span><span style="color: #bbb8ab;">console.</span>log<span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">;</span>
</pre>
</div>
<pre class="example">
undefined
</pre>
</div>
</div>


<div id="outline-container-org7fa72a7" class="outline-4">
<h4 id="org7fa72a7"><span class="section-number-4">1.0.4</span> Api function, first draft</h4>
<div class="outline-text-4" id="text-1-0-4">
<p>
We could let our business logic touch the database directly, but better application design would have us create an <i>api</i> layer to abstract the database layer.  This <i>api</i> layer can add naming, sanitize inputs, change data on getting or setting, and in general include the logic our application needs for the database layer.  Today, we will focus on throwing different errors when you gave the function <i>bad</i> data versus when the database returns <i>no</i> data.
</p>

<p>
To do this, we will make our api function <code>getUser</code>.
</p>

<p>
Especially coming from a python world, <i>throwing</i> errors and catching them in the consuming function is the norm.  Let&rsquo;s take a look at a similar approach in typescript here (the purpose of the article is rewriting this function, so this is our <i>first draft</i>):
</p>

<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #666;">let</span> <span style="color: #333;">isLoggedIn</span> = <span style="color: #666;">true</span><span style="color: #bbb8ab;">;</span> <span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">a fake little state variable</span>

<span style="color: #666;">const</span> <span style="color: #333;">getUser</span>
  <span style="color: #bbb8ab;">:</span> <span style="color: #ccc8bc;">(</span>id<span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">string</span><span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> Promise&lt;<span style="color: #bbb8ab;">User</span>&gt; <span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">type definition</span>
  = <span style="color: #111; font-style: italic;">async</span> <span style="color: #ccc8bc;">(</span>id<span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> <span style="color: #ccc8bc;">{</span>
    <span style="color: #111; font-style: italic;">if</span> <span style="color: #ccc8bc;">(</span>!<span style="color: #ccc8bc;">(</span><span style="color: #666;">typeof</span> id === <span style="color: teal;">`string`</span><span style="color: #ccc8bc;">)</span><span style="color: #ccc8bc;">)</span> <span style="color: #ccc8bc;">{</span>
      <span style="color: #666;">throw</span> <span style="color: #666;">new</span> <span style="color: #111; font-style: italic;">Error</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`bad query parameter`</span><span style="color: #ccc8bc;">)</span>
    <span style="color: #ccc8bc;">}</span>
    <span style="color: #111; font-style: italic;">if</span> <span style="color: #ccc8bc;">(</span>!isLoggedIn<span style="color: #ccc8bc;">)</span> <span style="color: #ccc8bc;">{</span>
      <span style="color: #666;">throw</span> <span style="color: #666;">new</span> <span style="color: #111; font-style: italic;">Error</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`bad user! that's illegal`</span><span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">;</span>
    <span style="color: #ccc8bc;">}</span>
    <span style="color: #666;">const</span> <span style="color: #333;">user</span> = <span style="color: #666;">await</span> db<span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">get</span><span style="color: #ccc8bc;">(</span>id<span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">;</span>

    <span style="color: #111; font-style: italic;">if</span> <span style="color: #ccc8bc;">(</span>!user<span style="color: #ccc8bc;">)</span> <span style="color: #ccc8bc;">{</span>
      <span style="color: #666;">throw</span> <span style="color: #666;">new</span> <span style="color: #111; font-style: italic;">Error</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`user ${id} not found`</span><span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">;</span>
    <span style="color: #ccc8bc;">}</span>
    <span style="color: #db7093;">return</span> user
  <span style="color: #ccc8bc;">}</span>

</pre>
</div>
<p>
as we can see, the function will now throw a certain error when we hand it bad data:
</p>
<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #666;">await</span> <span style="color: #111; font-style: italic;">getUser</span><span style="color: #ccc8bc;">(</span><span style="color: #666;">null</span><span style="color: #ccc8bc;">)</span>
  <span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">catch</span><span style="color: #ccc8bc;">(</span>e <span style="color: #666;">=&gt;</span> <span style="color: #bbb8ab;">console.</span><span style="color: #111; font-style: italic;">log</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`caught: ${e}`</span><span style="color: #ccc8bc;">)</span><span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">;</span>
</pre>
</div>
<pre class="example">
caught: Error: bad query parameter
</pre>


<p>
and will throw a different error when the user was not found:
</p>
<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #666;">await</span> <span style="color: #111; font-style: italic;">getUser</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">'76'</span><span style="color: #ccc8bc;">)</span>
  <span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">catch</span><span style="color: #ccc8bc;">(</span>e <span style="color: #666;">=&gt;</span> <span style="color: #bbb8ab;">console.</span><span style="color: #111; font-style: italic;">log</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`caught: ${e}`</span><span style="color: #ccc8bc;">)</span><span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">;</span>
</pre>
</div>
<pre class="example">
caught: Error: user 76 not found
</pre>


<p>
the code will also throw a completely separate error when the <i>requesting user is not logged in.</i>
</p>

<p>
All three of these <i>error cases</i> are expected errors.  They can happen when something in the environment changed, or when a client library is misusing the function in an expected way.
</p>

<p>
From the above results, we can see that we have now been handed <i>very</i> userful information back from <code>getUser</code> about <i>why</i> the function failed.
</p>

<p>
However, it is still difficult for the client application to <i>act</i> on the different types of errors.  What we would like to do, in pseudo-Code, is this:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">pseudo-code</span>
<span style="color: #111; font-style: italic;">getUser</span><span style="color: #ccc8bc;">(</span>id<span style="color: #ccc8bc;">)</span>
  <span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">then</span><span style="color: #ccc8bc;">(</span>processResult<span style="color: #ccc8bc;">)</span>
  <span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">catch</span><span style="color: #ccc8bc;">(</span><span style="color: #ccc8bc;">(</span>e<span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> <span style="color: #ccc8bc;">{</span>
    <span style="color: #111; font-style: italic;">if</span> <span style="color: #ccc8bc;">(</span>e === notFoundError<span style="color: #ccc8bc;">)</span> <span style="color: #111; font-style: italic;">goToNotFound</span><span style="color: #ccc8bc;">()</span><span style="color: #bbb8ab;">;</span>
    <span style="color: #111; font-style: italic;">if</span> <span style="color: #ccc8bc;">(</span>e === notLoggedInError<span style="color: #ccc8bc;">)</span> <span style="color: #111; font-style: italic;">goToLogin</span><span style="color: #ccc8bc;">()</span><span style="color: #bbb8ab;">;</span>
  <span style="color: #ccc8bc;">}</span><span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">;</span>
</pre>
</div>

<p>
To do this, we deffinitely need better error types, that are not just defined as strings in the function throwing them.
</p>
</div>
</div>

<div id="outline-container-org371e613" class="outline-3">
<h3 id="org371e613"><span class="section-number-3">1.1</span> Handling Known Errors</h3>
<div class="outline-text-3" id="text-1-1">
<p>
The advantage of typescript is in the name: typing.  We can easily make a few error types to test our results against.
</p>
</div>

<div id="outline-container-orgdf9e3da" class="outline-4">
<h4 id="orgdf9e3da"><span class="section-number-4">1.1.1</span> Error Types</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
The first thing we need to do is define a few error types.  In keeping with our very simple example, let&rsquo;s define three types, <code>BadInputError,</code> <code>NotFoundError</code> and <code>NoAuthError</code>.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #666;">type</span> <span style="color: #bbb8ab;">NotFoundError</span> = <span style="color: #ccc8bc;">{</span> <span style="color: #666;">readonly</span> _type<span style="color: #bbb8ab;">:</span> <span style="color: teal;">"NotFoundError"</span><span style="color: #bbb8ab;">;</span> msg<span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">string</span><span style="color: #bbb8ab;">;</span> <span style="color: #ccc8bc;">}</span><span style="color: #bbb8ab;">;</span>
<span style="color: #666;">type</span> <span style="color: #bbb8ab;">BadInputError</span> = <span style="color: #ccc8bc;">{</span> <span style="color: #666;">readonly</span> _type<span style="color: #bbb8ab;">:</span> <span style="color: teal;">"BadInputError"</span><span style="color: #bbb8ab;">;</span> msg<span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">string</span><span style="color: #bbb8ab;">;</span> <span style="color: #ccc8bc;">}</span><span style="color: #bbb8ab;">;</span>
<span style="color: #666;">type</span> <span style="color: #bbb8ab;">NoAuthError</span> = <span style="color: #ccc8bc;">{</span> <span style="color: #666;">readonly</span> _type<span style="color: #bbb8ab;">:</span> <span style="color: teal;">"NoAuthError"</span><span style="color: #bbb8ab;">;</span> msg<span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">string</span> <span style="color: #ccc8bc;">}</span><span style="color: #bbb8ab;">;</span>

<span style="color: #666;">type</span> <span style="color: #bbb8ab;">Err</span> = NotFoundError | BadInputError | NoAuthError

<span style="color: #666;">const</span> <span style="color: #333;">isNotFoundError</span> =
  <span style="color: #ccc8bc;">(</span>e<span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">:</span> e is NotFoundError <span style="color: #666;">=&gt;</span>
    e<span style="color: #bbb8ab;">.</span>_type === <span style="color: teal;">"NotFoundError"</span><span style="color: #bbb8ab;">;</span>

<span style="color: #666;">const</span> <span style="color: #333;">isNoAuthError</span> =
  <span style="color: #ccc8bc;">(</span>e<span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">:</span> e is NoAuthError <span style="color: #666;">=&gt;</span>
    e<span style="color: #bbb8ab;">.</span>_type === <span style="color: teal;">"NoAuthError"</span><span style="color: #bbb8ab;">;</span>

<span style="color: #666;">const</span> <span style="color: #333;">isBadInputError</span> =
  <span style="color: #ccc8bc;">(</span>e<span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">:</span> e is BadInputError <span style="color: #666;">=&gt;</span>
    e<span style="color: #bbb8ab;">.</span>_type === <span style="color: teal;">"BadInputError"</span><span style="color: #bbb8ab;">;</span>

</pre>
</div>
<p>
We should also define some <i>error creators</i>, that will pass additional information along to the client about our error types.  This allows our errors to be re-used by multiple functions.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #666;">const</span> <span style="color: #333;">notFoundError</span>
  <span style="color: #bbb8ab;">:</span> <span style="color: #ccc8bc;">(</span>msg<span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">string</span><span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> NotFoundError
  = <span style="color: #ccc8bc;">(</span>msg<span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> <span style="color: #ccc8bc;">(</span><span style="color: #ccc8bc;">{</span> _type<span style="color: #bbb8ab;">:</span> <span style="color: teal;">"NotFoundError"</span><span style="color: #bbb8ab;">,</span> msg <span style="color: #ccc8bc;">}</span><span style="color: #ccc8bc;">)</span>

<span style="color: #666;">const</span> <span style="color: #333;">noAuthError</span>
  <span style="color: #bbb8ab;">:</span> <span style="color: #ccc8bc;">(</span>msg<span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">string</span><span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> NoAuthError
  = <span style="color: #ccc8bc;">(</span>msg<span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> <span style="color: #ccc8bc;">(</span><span style="color: #ccc8bc;">{</span> _type<span style="color: #bbb8ab;">:</span> <span style="color: teal;">"NoAuthError"</span><span style="color: #bbb8ab;">,</span> msg <span style="color: #ccc8bc;">}</span><span style="color: #ccc8bc;">)</span>

<span style="color: #666;">const</span> <span style="color: #333;">badInputError</span>
  <span style="color: #bbb8ab;">:</span> <span style="color: #ccc8bc;">(</span>msg<span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">string</span><span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> BadInputError
  = <span style="color: #ccc8bc;">(</span>msg<span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> <span style="color: #ccc8bc;">(</span><span style="color: #ccc8bc;">{</span> _type<span style="color: #bbb8ab;">:</span> <span style="color: teal;">"BadInputError"</span><span style="color: #bbb8ab;">,</span> msg <span style="color: #ccc8bc;">}</span><span style="color: #ccc8bc;">)</span>
</pre>
</div>
<p>
(sidenote:  there are more DRY ways to accomplish the error creators and types, which I will talk about in another article.  We are keeping it simple here because we are illustrating something else)
</p>

<p>
We should now be able to create an error using one of the error creator functions:
</p>

<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #111; font-style: italic;">badInputError</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`bad user! bad!`</span><span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">;</span>
</pre>
</div>
<pre class="example">
{ _type: 'BadInputError', msg: 'bad user! bad!' }
</pre>


<p>
Note: Notice that we will not include a stack any more in our errors.  With <i>expected</i> errors, the stack should no longer be important, as we (the function), know why it failed, and just want to tell the consumer how <i>they</i> mest up.
</p>
</div>
</div>

<div id="outline-container-orgdc20385" class="outline-4">
<h4 id="orgdc20385"><span class="section-number-4">1.1.2</span> Rewrite the API function</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
Now, let&rsquo;s rewrite our little <code>getUser</code> function to actually throw these errors, and then re-implement the client pseudo-code as real code. The function does not look so different than before, exept now it throws errors that have <i>types</i>.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">rewrite our function to use error types</span>
<span style="color: #666;">const</span> <span style="color: #333;">getUser</span>
  <span style="color: #bbb8ab;">:</span> <span style="color: #ccc8bc;">(</span>id<span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">string</span><span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> Promise&lt;<span style="color: #bbb8ab;">User</span> | <span style="color: #bbb8ab;">never</span>&gt; <span style="color: #bbbbbb; font-style: italic;">// </span><span style="color: #bbbbbb; font-style: italic;">type definition</span>
  = <span style="color: #111; font-style: italic;">async</span> <span style="color: #ccc8bc;">(</span>id<span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span> <span style="color: #ccc8bc;">{</span>
    <span style="color: #111; font-style: italic;">if</span> <span style="color: #ccc8bc;">(</span>!<span style="color: #ccc8bc;">(</span><span style="color: #666;">typeof</span> id === <span style="color: teal;">`string`</span><span style="color: #ccc8bc;">)</span><span style="color: #ccc8bc;">)</span> <span style="color: #ccc8bc;">{</span>
      <span style="color: #666;">throw</span> <span style="color: #111; font-style: italic;">badInputError</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`bad query parameter`</span><span style="color: #ccc8bc;">)</span>
    <span style="color: #ccc8bc;">}</span>
    <span style="color: #111; font-style: italic;">if</span> <span style="color: #ccc8bc;">(</span>!isLoggedIn<span style="color: #ccc8bc;">)</span> <span style="color: #ccc8bc;">{</span>
      <span style="color: #666;">throw</span> <span style="color: #111; font-style: italic;">noAuthError</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`not logged in`</span><span style="color: #ccc8bc;">)</span>
    <span style="color: #ccc8bc;">}</span>
    <span style="color: #666;">const</span> <span style="color: #333;">user</span> = <span style="color: #666;">await</span> db<span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">get</span><span style="color: #ccc8bc;">(</span>id<span style="color: #ccc8bc;">)</span><span style="color: #bbb8ab;">;</span>

    <span style="color: #111; font-style: italic;">if</span> <span style="color: #ccc8bc;">(</span>!user<span style="color: #ccc8bc;">)</span> <span style="color: #ccc8bc;">{</span>
      <span style="color: #666;">throw</span> <span style="color: #111; font-style: italic;">notFoundError</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`this user id: ${id} not found. silly you!`</span><span style="color: #ccc8bc;">)</span>
    <span style="color: #ccc8bc;">}</span>
    <span style="color: #db7093;">return</span> user
  <span style="color: #ccc8bc;">}</span>

</pre>
</div>
<p>
we can still get a user that exists:
</p>
<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #666;">await</span> <span style="color: #111; font-style: italic;">getUser</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">"2"</span><span style="color: #ccc8bc;">)</span>
  <span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">then</span><span style="color: #ccc8bc;">(</span>u <span style="color: #666;">=&gt;</span> <span style="color: #bbb8ab;">console.</span><span style="color: #111; font-style: italic;">log</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`got user ${u.name}`</span><span style="color: #ccc8bc;">)</span><span style="color: #ccc8bc;">)</span>
</pre>
</div>
<pre class="example">
got user kristina
</pre>


<p>
and a failed try will still throw:
</p>
<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #666;">await</span> <span style="color: #111; font-style: italic;">getUser</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">"27"</span><span style="color: #ccc8bc;">)</span>
  <span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">catch</span><span style="color: #ccc8bc;">(</span>e <span style="color: #666;">=&gt;</span> <span style="color: #bbb8ab;">console.</span><span style="color: #111; font-style: italic;">log</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`caught: ${e._type}: ${e.msg}`</span><span style="color: #ccc8bc;">)</span><span style="color: #ccc8bc;">)</span>
</pre>
</div>
<pre class="example">
caught: NotFoundError: this user id: 27 not found. silly you!
</pre>


<p>
however, because the <i>thrown</i> errors are now <i>typed</i>, we can easily test them:
</p>
<div class="org-src-container">
<pre class="src src-jupyter-typescript"><span style="color: #666;">await</span> <span style="color: #111; font-style: italic;">getUser</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">"666"</span><span style="color: #ccc8bc;">)</span>
  <span style="color: #bbb8ab;">.</span><span style="color: #111; font-style: italic;">catch</span><span style="color: #ccc8bc;">(</span>
    <span style="color: #ccc8bc;">(</span>e<span style="color: #ccc8bc;">)</span> <span style="color: #666;">=&gt;</span>
      <span style="color: #111; font-style: italic;">isNotFoundError</span><span style="color: #ccc8bc;">(</span>e<span style="color: #ccc8bc;">)</span>
      ? <span style="color: #bbb8ab;">console.</span><span style="color: #111; font-style: italic;">log</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`do /something/ on not found`</span><span style="color: #ccc8bc;">)</span>
      <span style="color: #bbb8ab;">:</span> <span style="color: #111; font-style: italic;">isNoAuthError</span><span style="color: #ccc8bc;">(</span>e<span style="color: #ccc8bc;">)</span>
      ? <span style="color: #bbb8ab;">console.</span><span style="color: #111; font-style: italic;">log</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`you are not logged in, caught it`</span><span style="color: #ccc8bc;">)</span>
      <span style="color: #bbb8ab;">:</span> <span style="color: #111; font-style: italic;">isBadInputError</span><span style="color: #ccc8bc;">(</span>e<span style="color: #ccc8bc;">)</span>
      ? <span style="color: #bbb8ab;">console.</span><span style="color: #111; font-style: italic;">log</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`bad input`</span><span style="color: #ccc8bc;">)</span>
      <span style="color: #bbb8ab;">:</span> <span style="color: #bbb8ab;">console.</span><span style="color: #111; font-style: italic;">log</span><span style="color: #ccc8bc;">(</span><span style="color: teal;">`something truly unexpected happened`</span><span style="color: #ccc8bc;">)</span>
  <span style="color: #ccc8bc;">)</span>

</pre>
</div>
<pre class="example">
do /something/ on not found
</pre>


<p>
Success!  we are now able to distinguish between errors and act on them accordingly. In the above code, we catch the function we knew was going to fail, and then did something different depending on the type of error that it was, using the error test functions we wrote before.
</p>

<p>
<i>Hooooowever</i>
</p>

<p>
There is still one problem.  It would be fantastic if our <code>getUser</code> function were able to tell us in it&rsquo;s type definition what kind of errors it <i>expects.</i>
</p>

<p>
In typescript <i>throwing</i> errors <i>always</i> results in the <code>never</code> type.  Typescript is supposed to allow for very specific type definitions of functions, but in the case of functions that throw errors, you either get the defined success type or&#x2026;. well, <i>never.</i>
</p>

<p>
Take another look at the function definition:
</p>

<p>
<code>getUser: (id: string) ==&gt; Promise&lt;User | never&gt;</code>
</p>

<p>
In our small, simple function, it is pretty easy to manually look through the function to see which errors it might throw. However - In more complicated functions, where a function calls nested or imported sub-routines that might throw their own errors, this becomes difficult to track or handle.
</p>

<p>
Realistically, what we want is the error <i>types</i> in the function definition.
</p>

<p>
One method of dealing with this issue would be to <i>return</i> the errors instead of <i>throwing</i> them.
In this solution, our function definition would look like this:
</p>

<p>
<code>getUser: (id: string) ==&gt; Promise&lt;User | BadInputError | NoAuthError | NotFoundError&gt;</code>
</p>

<p>
Personally, I don&rsquo;t like this solution, because it makes no distinction between the success case of the function and a failure, which may be the first type of test a consuming function might want to do.
</p>

<p>
Ideally, we want to create an interface similare to <code>Promise.then/catch</code>, that will allow us to reason about the function&rsquo;s results elegantly.
</p>
</div>
</div>

<div id="outline-container-org136ae80" class="outline-4">
<h4 id="org136ae80"><span class="section-number-4">1.1.3</span> <i>monads</i> to the rescue!</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
the change here is that <code>catch</code> is only used any more for <i>unexpected</i> results, everything else is handled as part of the new data-flow type.
</p>

<p>
this would require our new <code>doThing</code> function to look a lot closer to this:
</p>

<ul class="org-ul">
<li><i>codify</i> expected errors, and include them in the type definitions of functions</li>

<li><i>share</i> firebase function types : put one in <code>functions/src/index</code> and one in your <code>api</code> layer linking to the function by string.  this will keep both up to date</li>
</ul>

<div class="org-src-container">
<pre class="src src-jupyter-typescript">
<span style="color: #666;">type</span> <span style="color: #bbb8ab;">SuccessOrFailure</span> = <span style="color: #ccc8bc;">{</span>
<span style="color: #ccc8bc;">}</span>

</pre>
</div>

<p>
&#x2026; to be continued
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: John Doe</p>
<p class="date">Created: 2021-01-15 Fri 06:05</p>
</div>
</body>
</html>
